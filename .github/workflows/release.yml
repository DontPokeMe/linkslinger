name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"

      - name: Verify manifest version matches tag
        run: |
          # Use jq if available, otherwise use sed (more portable than grep -P)
          if command -v jq &> /dev/null; then
            MANIFEST_VERSION=$(jq -r '.version' src/manifest.json)
          else
            MANIFEST_VERSION=$(grep -o '"version":\s*"[^"]*"' src/manifest.json | sed 's/.*"version":\s*"\([^"]*\)".*/\1/')
          fi
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          echo "Manifest version: $MANIFEST_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Manifest version ($MANIFEST_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi
          echo "âœ“ Version match: $MANIFEST_VERSION"

      - name: Create build directory
        run: mkdir -p build

      - name: Copy extension files
        run: |
          rsync -av \
            --exclude .git \
            --exclude .github \
            --exclude node_modules \
            --exclude build \
            --exclude release \
            --exclude .gitignore \
            --exclude README.md \
            --exclude package.json \
            --exclude package-lock.json \
            --exclude .vscode \
            --exclude .DS_Store \
            --exclude '*.log' \
            --exclude .env \
            --exclude '*.zip' \
            src/ build/

      - name: Create zip archive
        run: |
          cd build
          zip -r ../linkslinger-v${{ steps.tag_version.outputs.version }}.zip .
          cd ..

      - name: Generate release notes
        id: release_notes
        run: |
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          NOTES="## LinkSlinger v${TAG_VERSION}

          ### Changes
          - See commit history for detailed changes

          ### Installation
          1. Download \`linkslinger-v${TAG_VERSION}.zip\` from Assets below
          2. Unzip the file
          3. Open Chrome and navigate to \`chrome://extensions/\`
          4. Enable \"Developer mode\" (toggle in top-right)
          5. Click \"Load unpacked\" and select the unzipped folder

          ### Files
          - \`linkslinger-v${TAG_VERSION}.zip\` - Extension package ready for installation"
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: linkslinger-v${{ steps.tag_version.outputs.version }}.zip
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display release info
        run: |
          echo "âœ“ Release created: v${{ steps.tag_version.outputs.version }}"
          echo "ðŸ“¦ File: linkslinger-v${{ steps.tag_version.outputs.version }}.zip"
