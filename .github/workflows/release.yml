name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Extract version from tag
        id: tag_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION=${{ github.event.release.tag_name }}
            VERSION=${VERSION#v}
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"

      - name: Verify manifest version matches tag
        run: |
          # Guard: fail if tag and manifest version differ (prevents accidental mismatches)
          if command -v jq &> /dev/null; then
            MANIFEST_VERSION=$(jq -r '.version' src/manifest.json)
          else
            MANIFEST_VERSION=$(grep -o '"version":\s*"[^"]*"' src/manifest.json | sed 's/.*"version":\s*"\([^"]*\)".*/\1/')
          fi
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          echo "Manifest version: $MANIFEST_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Manifest version ($MANIFEST_VERSION) does not match tag version ($TAG_VERSION). Update manifest or tag before releasing."
            exit 1
          fi
          echo "âœ“ Version match: $MANIFEST_VERSION"

      - name: Create build directory
        run: mkdir -p build

      - name: Copy extension files
        run: |
          # Verify src directory exists
          if [ ! -d "src" ]; then
            echo "Error: src directory not found"
            exit 1
          fi
          
          # Copy files with rsync (continue even if some files are missing)
          rsync -av \
            --exclude .git \
            --exclude .github \
            --exclude node_modules \
            --exclude build \
            --exclude release \
            --exclude .gitignore \
            --exclude README.md \
            --exclude package.json \
            --exclude package-lock.json \
            --exclude .vscode \
            --exclude .DS_Store \
            --exclude '*.log' \
            --exclude .env \
            --exclude '*.zip' \
            src/ build/ || {
              echo "Warning: rsync completed with errors, but continuing..."
            }
          
          # Verify manifest.json was copied
          if [ ! -f "build/manifest.json" ]; then
            echo "Error: manifest.json not found in build directory"
            exit 1
          fi
          
          echo "âœ“ Files copied successfully"

      - name: Create zip archive
        run: |
          cd build
          # Verify we have required files
          if [ ! -f "manifest.json" ]; then
            echo "Error: manifest.json missing"
            exit 1
          fi
          if [ ! -f "content.js" ]; then
            echo "Error: content.js missing"
            exit 1
          fi
          if [ ! -f "background.js" ]; then
            echo "Error: background.js missing"
            exit 1
          fi
          
          zip -r ../linkslinger-v${{ steps.tag_version.outputs.version }}.zip . || {
            echo "Error: zip creation failed"
            exit 1
          }
          cd ..
          
          # Verify zip was created
          if [ ! -f "linkslinger-v${{ steps.tag_version.outputs.version }}.zip" ]; then
            echo "Error: zip file not created"
            exit 1
          fi
          
          echo "âœ“ Zip archive created successfully"

      - name: Generate release notes
        id: release_notes
        run: |
          TAG_VERSION="${{ steps.tag_version.outputs.version }}"
          NOTES="## LinkSlinger v${TAG_VERSION}

          ### Changes
          - See commit history for detailed changes

          ### Installation
          1. Download \`linkslinger-v${TAG_VERSION}.zip\` from Assets below
          2. Unzip the file
          3. Open Chrome and navigate to \`chrome://extensions/\`
          4. Enable \"Developer mode\" (toggle in top-right)
          5. Click \"Load unpacked\" and select the unzipped folder

          ### Files
          - \`linkslinger-v${TAG_VERSION}.zip\` - Extension package ready for installation"
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.tag_version.outputs.version }}
          files: linkslinger-v${{ steps.tag_version.outputs.version }}.zip
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display release info
        run: |
          echo "âœ“ Release created: v${{ steps.tag_version.outputs.version }}"
          echo "ðŸ“¦ File: linkslinger-v${{ steps.tag_version.outputs.version }}.zip"
