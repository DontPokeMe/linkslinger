name: Publish to Chrome Web Store

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.event.release.draft == false
    permissions:
      contents: read
      releases: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from release tag
        id: tag_version
        run: |
          if [ "${{ github.event.release.tag_name }}" != "" ]; then
            # Extract version from release tag name (e.g., v3.0.0 -> 3.0.0)
            VERSION=$(echo "${{ github.event.release.tag_name }}" | sed 's/^v//')
          else
            # Fallback: read from manifest.json (use sed instead of grep -P for portability)
            if command -v jq &> /dev/null; then
              VERSION=$(jq -r '.version' src/manifest.json)
            else
              VERSION=$(grep -o '"version":\s*"[^"]*"' src/manifest.json | sed 's/.*"version":\s*"\([^"]*\)".*/\1/')
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install chrome-webstore-upload-cli
        run: npm install -g chrome-webstore-upload-cli

      - name: Build extension package
        run: |
          VERSION="${{ steps.tag_version.outputs.version }}"
          echo "Building extension v${VERSION}..."
          
          # Verify src directory exists
          if [ ! -d "src" ]; then
            echo "Error: src directory not found"
            exit 1
          fi
          
          mkdir -p build
          rsync -av \
            --exclude .git \
            --exclude .github \
            --exclude node_modules \
            --exclude build \
            --exclude release \
            --exclude .gitignore \
            --exclude README.md \
            --exclude package.json \
            --exclude package-lock.json \
            --exclude .vscode \
            --exclude .DS_Store \
            --exclude '*.log' \
            --exclude .env \
            --exclude '*.zip' \
            src/ build/ || {
              echo "Warning: rsync completed with errors, but continuing..."
            }
          
          # Verify manifest.json was copied
          if [ ! -f "build/manifest.json" ]; then
            echo "Error: manifest.json not found in build directory"
            exit 1
          fi
          
          cd build
          # Verify we have required files
          if [ ! -f "content.js" ]; then
            echo "Error: content.js missing"
            exit 1
          fi
          if [ ! -f "background.js" ]; then
            echo "Error: background.js missing"
            exit 1
          fi
          
          zip -r ../linkslinger-v${VERSION}.zip . || {
            echo "Error: zip creation failed"
            exit 1
          }
          cd ..
          
          # Verify zip was created
          if [ ! -f "linkslinger-v${VERSION}.zip" ]; then
            echo "Error: zip file not created"
            exit 1
          fi
          
          echo "‚úÖ Extension built: linkslinger-v${VERSION}.zip"

      - name: Find zip file
        id: find_zip
        run: |
          ZIP_FILE=$(find . -maxdepth 1 -name "linkslinger-v*.zip" -type f | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "‚ùå No zip file found"
            exit 1
          fi
          echo "file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "Found zip file: $ZIP_FILE"
          ls -lh "$ZIP_FILE"

      - name: Publish to Chrome Web Store
        env:
          EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
        run: |
          if [ -z "$EXTENSION_ID" ] || [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ] || [ -z "$REFRESH_TOKEN" ]; then
            echo "‚ö†Ô∏è  Chrome Web Store secrets not configured. Skipping auto-publish."
            echo "To enable auto-publish, add the following secrets to GitHub:"
            echo "  - CHROME_EXTENSION_ID"
            echo "  - CHROME_CLIENT_ID"
            echo "  - CHROME_CLIENT_SECRET"
            echo "  - CHROME_REFRESH_TOKEN"
            exit 0
          fi

          ZIP_FILE="${{ steps.find_zip.outputs.file }}"
          echo "üì¶ Uploading $ZIP_FILE to Chrome Web Store..."
          
          chrome-webstore-upload upload \
            --source "$ZIP_FILE" \
            --extension-id "$EXTENSION_ID" \
            --client-id "$CLIENT_ID" \
            --client-secret "$CLIENT_SECRET" \
            --refresh-token "$REFRESH_TOKEN" \
            --auto-publish || {
              echo "‚ö†Ô∏è  Upload failed. You may need to publish manually from Chrome Web Store Developer Dashboard."
              exit 0
            }

          echo "‚úÖ Successfully published to Chrome Web Store!"
